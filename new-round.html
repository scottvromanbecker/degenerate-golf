<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Start a New Round - Degenerate Golf Games</title>
    <style>
        :root {
            --masters-green: #006747;
            --masters-dark: #004d35;
            --masters-yellow: #f1c40f;
            --masters-cream: #fdf6e3;
            --masters-light: #e8f5e9;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, var(--masters-dark) 0%, var(--masters-green) 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: var(--masters-dark);
            padding: 20px;
            text-align: center;
            border-bottom: 4px solid var(--masters-yellow);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            color: var(--masters-yellow);
            font-size: 1.8rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header-subtitle {
            color: #fff;
            font-size: 1rem;
            margin-top: 5px;
            opacity: 0.9;
        }
        
        .main-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            gap: 20px;
        }
        
        .content-area {
            flex: 1;
            min-width: 0;
        }
        
        .sidebar {
            width: 320px;
            flex-shrink: 0;
        }
        
        .card {
            background: var(--masters-cream);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .card h2 {
            color: var(--masters-dark);
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid var(--masters-yellow);
            padding-bottom: 10px;
        }
        
        .card h3 {
            color: var(--masters-dark);
            margin: 15px 0 10px 0;
            font-size: 1.1rem;
        }
        
        /* Team Selection Styles */
        .team-selection {
            text-align: center;
            max-width: 600px;
            margin: 40px auto;
        }
        
        .player-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .player-slot {
            background: #fff;
            border: 3px solid var(--masters-green);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .player-slot:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .player-slot.selected {
            background: var(--masters-green);
            color: #fff;
        }
        
        .player-slot.team1 {
            border-color: var(--masters-yellow);
            background: linear-gradient(135deg, #fff 0%, #fffde7 100%);
        }
        
        .player-slot.team1.selected {
            background: var(--masters-yellow);
            color: var(--masters-dark);
        }
        
        .player-slot.team2 {
            border-color: #2196F3;
            background: linear-gradient(135deg, #fff 0%, #e3f2fd 100%);
        }
        
        .player-slot.team2.selected {
            background: #2196F3;
            color: #fff;
        }
        
        .team-label {
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .player-name {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .team-preview {
            margin: 30px 0;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
        }
        
        .team-preview h3 {
            margin-bottom: 15px;
        }
        
        .team-display {
            display: flex;
            justify-content: space-around;
            gap: 20px;
        }
        
        .team-box {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .team-box.team1-box {
            background: linear-gradient(135deg, var(--masters-yellow) 0%, #f39c12 100%);
            color: var(--masters-dark);
        }
        
        .team-box.team2-box {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: #fff;
        }
        
        /* Hole Tracking Styles */
        .hole-header {
            background: var(--masters-dark);
            color: var(--masters-yellow);
            padding: 15px 25px;
            border-radius: 15px 15px 0 0;
            margin: -25px -25px 20px -25px;
            font-size: 1.8rem;
            text-align: center;
        }
        
        .question-group {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .question-group:last-of-type {
            border-bottom: none;
        }
        
        .question-label {
            font-weight: bold;
            color: var(--masters-dark);
            margin-bottom: 12px;
            font-size: 1.1rem;
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        .btn-primary {
            background: var(--masters-green);
            color: #fff;
        }
        
        .btn-primary:hover {
            background: var(--masters-dark);
            transform: translateY(-2px);
        }
        
        .btn-yellow {
            background: var(--masters-yellow);
            color: var(--masters-dark);
        }
        
        .btn-yellow:hover {
            background: #f39c12;
            transform: translateY(-2px);
        }
        
        .btn-option {
            background: #fff;
            color: var(--masters-dark);
            border: 2px solid var(--masters-green);
        }
        
        .btn-option:hover {
            background: var(--masters-light);
        }
        
        .btn-option.selected {
            background: var(--masters-green);
            color: #fff;
        }
        
        .btn-option.team1-btn.selected {
            background: var(--masters-yellow);
            color: var(--masters-dark);
            border-color: var(--masters-yellow);
        }
        
        .btn-option.team2-btn.selected {
            background: #2196F3;
            color: #fff;
            border-color: #2196F3;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .checkbox-btn {
            padding: 10px 20px;
            background: #fff;
            border: 2px solid #ccc;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .checkbox-btn:hover {
            border-color: var(--masters-green);
        }
        
        .checkbox-btn.checked {
            background: var(--masters-green);
            color: #fff;
            border-color: var(--masters-green);
        }
        
        .wam-last-select {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            border: 2px solid var(--masters-yellow);
        }
        
        .wam-last-select label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--masters-dark);
        }
        
        .wam-last-select select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1rem;
        }
        
        .par3-section {
            margin-top: 15px;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            border: 2px solid var(--masters-green);
        }
        
        .par3-section.hidden {
            display: none;
        }
        
        /* Sidebar Styles */
        .sidebar .card {
            position: sticky;
            top: 100px;
        }
        
        .tally-section {
            margin-bottom: 20px;
        }
        
        .tally-title {
            font-weight: bold;
            color: var(--masters-dark);
            margin-bottom: 8px;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tally-value {
            background: #fff;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .tally-pot {
            color: var(--masters-green);
            font-weight: bold;
        }
        
        .bel-air-status {
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            text-align: center;
        }
        
        .bel-air-score {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .player-balance {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: #fff;
            border-radius: 5px;
            margin-bottom: 5px;
        }
        
        .player-balance .name {
            font-weight: bold;
        }
        
        .player-balance .amount {
            font-weight: bold;
        }
        
        .player-balance .amount.positive {
            color: #27ae60;
        }
        
        .player-balance .amount.negative {
            color: #e74c3c;
        }
        
        /* Navigation */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            gap: 15px;
        }
        
        .nav-buttons .btn {
            flex: 1;
            padding: 15px;
            font-size: 1.1rem;
        }
        
        /* Summary Styles */
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9rem;
        }
        
        .summary-table th,
        .summary-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .summary-table th {
            background: var(--masters-dark);
            color: #fff;
        }
        
        .summary-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .summary-table .hole-9,
        .summary-table .hole-18 {
            background: var(--masters-yellow);
            font-weight: bold;
        }
        
        .final-totals {
            margin-top: 30px;
        }
        
        .final-totals h3 {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .total-card {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .total-card .player-name {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        
        .total-card .total-amount {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .total-card .total-amount.positive {
            color: #27ae60;
        }
        
        .total-card .total-amount.negative {
            color: #e74c3c;
        }
        
        .back-link {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 24px;
            background: var(--masters-dark);
            color: var(--masters-yellow);
            text-decoration: none;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        
        .back-link:hover {
            background: #000;
            transform: translateY(-2px);
        }
        
        /* View management */
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 900px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: -1;
            }
            
            .sidebar .card {
                position: static;
            }
        }
        
        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.4rem;
            }
            
            .team-display {
                flex-direction: column;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>‚õ≥ DEGENERATE GOLF GAMES ‚õ≥</h1>
        <div class="header-subtitle" id="headerSubtitle">New Round Setup</div>
    </header>

    <!-- Team Selection View -->
    <div id="teamSelectionView" class="view active">
        <div class="team-selection">
            <div class="card">
                <h2>Select Teams for Today's Round</h2>
                <p style="margin-bottom: 20px; color: #666;">Click players to pair them into teams. First two selected = Team 1 (Gold), next two = Team 2 (Blue).</p>
                
                <div class="player-grid" id="playerGrid">
                    <div class="player-slot" data-player="Becker" onclick="togglePlayer(this)">
                        <div class="team-label" id="label-Becker"></div>
                        <div class="player-name">Becker</div>
                    </div>
                    <div class="player-slot" data-player="Murph" onclick="togglePlayer(this)">
                        <div class="team-label" id="label-Murph"></div>
                        <div class="player-name">Murph</div>
                    </div>
                    <div class="player-slot" data-player="Higgins" onclick="togglePlayer(this)">
                        <div class="team-label" id="label-Higgins"></div>
                        <div class="player-name">Higgins</div>
                    </div>
                    <div class="player-slot" data-player="Arguello" onclick="togglePlayer(this)">
                        <div class="team-label" id="label-Arguello"></div>
                        <div class="player-name">Arguello</div>
                    </div>
                </div>
                
                <div class="team-preview" id="teamPreview" style="display: none;">
                    <h3>Team Matchup</h3>
                    <div class="team-display">
                        <div class="team-box team1-box">
                            <div style="font-size: 0.8rem; margin-bottom: 5px;">TEAM 1</div>
                            <div id="team1Display" style="font-weight: bold;"></div>
                        </div>
                        <div style="display: flex; align-items: center; font-weight: bold; color: var(--masters-dark);">VS</div>
                        <div class="team-box team2-box">
                            <div style="font-size: 0.8rem; margin-bottom: 5px;">TEAM 2</div>
                            <div id="team2Display" style="font-weight: bold;"></div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-yellow" id="startRoundBtn" onclick="startRound()" style="display: none; width: 100%; padding: 18px; font-size: 1.2rem; margin-top: 20px;">
                    Start Round ‚Üí
                </button>
            </div>
            
            <a href="index.html" class="back-link">‚Üê Back to Leaderboard</a>
        </div>
    </div>

    <!-- Hole Tracking View -->
    <div id="holeTrackingView" class="view">
        <div class="main-container">
            <div class="content-area">
                <div class="card">
                    <div class="hole-header">Hole #<span id="currentHoleNum">1</span></div>
                    
                    <!-- Question 1: Bel Air -->
                    <div class="question-group">
                        <div class="question-label">Who won the hole? (Bel Air)</div>
                        <div class="btn-group" id="belAirBtns">
                            <button class="btn btn-option team1-btn" data-value="team1" onclick="selectBelAir(this)">
                                <span id="belAirTeam1Name">Team 1</span>
                            </button>
                            <button class="btn btn-option team2-btn" data-value="team2" onclick="selectBelAir(this)">
                                <span id="belAirTeam2Name">Team 2</span>
                            </button>
                            <button class="btn btn-option" data-value="push" onclick="selectBelAir(this)">
                                Push
                            </button>
                        </div>
                    </div>
                    
                    <!-- Question 2: Snake -->
                    <div class="question-group">
                        <div class="question-label">Who 3-putted? (Snake)</div>
                        <div class="checkbox-group" id="snakeCheckboxes">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Question 3: WAM -->
                    <div class="question-group">
                        <div class="question-label">Who had a WAM?</div>
                        <div class="checkbox-group" id="wamCheckboxes">
                            <!-- Populated by JS -->
                        </div>
                        <div class="wam-last-select" id="wamLastSelect" style="display: none;">
                            <label>Who had the WAM last?</label>
                            <select id="wamLastPlayer" onchange="updateWamLast()">
                                <option value="">-- Select --</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Question 4: CTP -->
                    <div class="question-group">
                        <div class="question-label">Closest to Pin?</div>
                        <div class="btn-group">
                            <button class="btn btn-option" id="par3Btn" onclick="togglePar3()">
                                Par 3
                            </button>
                        </div>
                        <div class="par3-section hidden" id="par3Section">
                            <div class="question-label" style="margin-top: 0;">Who was closest?</div>
                            <div class="btn-group" id="ctpBtns">
                                <!-- Populated by JS -->
                            </div>
                            <button class="btn btn-option" style="margin-top: 10px;" data-value="none" onclick="selectCTP(this)">
                                No one on green (rollover)
                            </button>
                        </div>
                    </div>
                    
                    <!-- Navigation -->
                    <div class="nav-buttons">
                        <button class="btn btn-primary" id="prevHoleBtn" onclick="prevHole()" style="display: none;">
                            ‚Üê Previous
                        </button>
                        <button class="btn btn-yellow" id="nextHoleBtn" onclick="nextHole()">
                            Next Hole ‚Üí
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="card">
                    <h2>Running Tally</h2>
                    
                    <!-- Bel Air Status -->
                    <div class="tally-section">
                        <div class="tally-title">Bel Air Match</div>
                        <div class="bel-air-status">
                            <div id="belAirMatchStatus">Match not started</div>
                            <div class="bel-air-score" id="belAirScore">0 - 0</div>
                            <div id="belAirBetStatus" style="font-size: 0.85rem; color: #666;">$60/man bet active</div>
                        </div>
                    </div>
                    
                    <!-- Snake Status -->
                    <div class="tally-section">
                        <div class="tally-title">
                            Snake 
                            <span class="tally-pot" id="snakePot">Pot: $10</span>
                        </div>
                        <div class="tally-value" id="snakeHolders">No one has the snake</div>
                    </div>
                    
                    <!-- WAM Status -->
                    <div class="tally-section">
                        <div class="tally-title">
                            WAM
                            <span class="tally-pot" id="wamPot">Pot: $0</span>
                        </div>
                        <div class="tally-value" id="wamHolder">No one has the WAM</div>
                    </div>
                    
                    <!-- CTP Status -->
                    <div class="tally-section">
                        <div class="tally-title">
                            CTP Rollover
                            <span class="tally-pot" id="ctpRollover">$0</span>
                        </div>
                    </div>
                    
                    <!-- Current Balances -->
                    <div class="tally-section">
                        <div class="tally-title">Current Balances</div>
                        <div id="currentBalances">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary View -->
    <div id="summaryView" class="view">
        <div class="main-container">
            <div class="content-area">
                <div class="card">
                    <h2>üèÜ Round Summary</h2>
                    
                    <!-- Bel Air Summary -->
                    <h3>Bel Air Match Progression</h3>
                    <div id="belAirSummary"></div>
                    
                    <!-- Hole by Hole -->
                    <h3 style="margin-top: 30px;">Hole-by-Hole Results</h3>
                    <div style="overflow-x: auto;">
                        <table class="summary-table" id="holeSummaryTable">
                            <thead>
                                <tr>
                                    <th>Hole</th>
                                    <th>Bel Air</th>
                                    <th>3-Putts</th>
                                    <th>WAM</th>
                                    <th>CTP</th>
                                </tr>
                            </thead>
                            <tbody id="holeSummaryBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Game Payouts -->
                    <h3 style="margin-top: 30px;">Game Payouts</h3>
                    <div id="gamePayouts"></div>
                    
                    <!-- Final Totals -->
                    <div class="final-totals">
                        <h3>üí∞ Final Standings</h3>
                        <div class="totals-grid" id="finalTotals">
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <a href="index.html" class="back-link">‚Üê Back to Leaderboard</a>
                        <button class="btn btn-yellow" onclick="resetRound()" style="margin-left: 15px;">Start New Round</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== GAME STATE ====================
        const PLAYERS = ['Becker', 'Murph', 'Higgins', 'Arguello'];
        
        let gameState = {
            teams: { team1: [], team2: [] },
            currentHole: 1,
            holes: [], // Array of hole data
            belAir: {
                team1Holes: 0,
                team2Holes: 0,
                currentBet: 60,
                closedOut: false,
                closedOutHole: null,
                newBetTeam1Holes: 0,
                newBetTeam2Holes: 0
            },
            snake: {
                frontPot: 10, // Starts at $10
                backPot: 0,
                frontHolders: [],
                backHolders: [],
                currentHolders: [] // Who currently "has" the snake
            },
            wam: {
                frontPot: 0, // Starts at $0
                backPot: 0,
                frontHolder: null,
                backHolder: null,
                currentHolder: null
            },
            ctp: {
                rollover: 0,
                results: [] // {hole, winner, amount}
            },
            balances: {}
        };
        
        // Initialize balances
        PLAYERS.forEach(p => gameState.balances[p] = 0);
        
        // ==================== LOCAL STORAGE ====================
        function saveState() {
            const saveData = {
                ...gameState,
                savedDate: new Date().toDateString()
            };
            localStorage.setItem('degenerateGolfRound', JSON.stringify(saveData));
        }
        
        function loadState() {
            const saved = localStorage.getItem('degenerateGolfRound');
            if (saved) {
                const data = JSON.parse(saved);
                // Check if it's from today
                if (data.savedDate === new Date().toDateString()) {
                    gameState = data;
                    return true;
                } else {
                    // Clear old data (midnight reset)
                    localStorage.removeItem('degenerateGolfRound');
                }
            }
            return false;
        }
        
        function resetRound() {
            localStorage.removeItem('degenerateGolfRound');
            location.reload();
        }
        
        // ==================== TEAM SELECTION ====================
        let selectedPlayers = [];
        
        function togglePlayer(element) {
            const player = element.dataset.player;
            const index = selectedPlayers.indexOf(player);
            
            if (index > -1) {
                // Deselect
                selectedPlayers.splice(index, 1);
                element.classList.remove('selected', 'team1', 'team2');
                document.getElementById('label-' + player).textContent = '';
            } else if (selectedPlayers.length < 4) {
                // Select
                selectedPlayers.push(player);
                element.classList.add('selected');
                
                if (selectedPlayers.length <= 2) {
                    element.classList.add('team1');
                    document.getElementById('label-' + player).textContent = 'Team 1';
                } else {
                    element.classList.add('team2');
                    document.getElementById('label-' + player).textContent = 'Team 2';
                }
            }
            
            updateTeamPreview();
        }
        
        function updateTeamPreview() {
            const preview = document.getElementById('teamPreview');
            const startBtn = document.getElementById('startRoundBtn');
            
            if (selectedPlayers.length === 4) {
                preview.style.display = 'block';
                startBtn.style.display = 'block';
                
                document.getElementById('team1Display').textContent = 
                    selectedPlayers.slice(0, 2).join(' & ');
                document.getElementById('team2Display').textContent = 
                    selectedPlayers.slice(2, 4).join(' & ');
            } else {
                preview.style.display = 'none';
                startBtn.style.display = 'none';
            }
        }
        
        function startRound() {
            gameState.teams.team1 = selectedPlayers.slice(0, 2);
            gameState.teams.team2 = selectedPlayers.slice(2, 4);
            
            // Initialize hole data
            for (let i = 1; i <= 18; i++) {
                gameState.holes.push({
                    hole: i,
                    belAir: null, // 'team1', 'team2', or 'push'
                    threePutts: [],
                    wams: [],
                    wamLast: null,
                    isPar3: false,
                    ctpWinner: null
                });
            }
            
            // Initialize snake pot for hole 1
            gameState.snake.frontPot = 10;
            
            saveState();
            showHoleTracking();
        }
        
        // ==================== VIEW MANAGEMENT ====================
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }
        
        function showHoleTracking() {
            showView('holeTrackingView');
            document.getElementById('headerSubtitle').textContent = 'Round in Progress';
            populateHoleUI();
            updateSidebar();
        }
        
        function showSummary() {
            showView('summaryView');
            document.getElementById('headerSubtitle').textContent = 'Round Complete';
            calculateFinalPayouts();
            renderSummary();
        }
        
        // ==================== HOLE TRACKING UI ====================
        function populateHoleUI() {
            const hole = gameState.currentHole;
            const holeData = gameState.holes[hole - 1];
            
            document.getElementById('currentHoleNum').textContent = hole;
            
            // Update team names in Bel Air buttons
            document.getElementById('belAirTeam1Name').textContent = 
                gameState.teams.team1.join(' & ');
            document.getElementById('belAirTeam2Name').textContent = 
                gameState.teams.team2.join(' & ');
            
            // Populate Snake checkboxes
            const snakeDiv = document.getElementById('snakeCheckboxes');
            snakeDiv.innerHTML = PLAYERS.map(p => `
                <div class="checkbox-btn ${holeData.threePutts.includes(p) ? 'checked' : ''}" 
                     data-player="${p}" onclick="toggleSnake(this)">
                    ${p}
                </div>
            `).join('');
            
            // Populate WAM checkboxes
            const wamDiv = document.getElementById('wamCheckboxes');
            wamDiv.innerHTML = PLAYERS.map(p => `
                <div class="checkbox-btn ${holeData.wams.includes(p) ? 'checked' : ''}" 
                     data-player="${p}" onclick="toggleWam(this)">
                    ${p}
                </div>
            `).join('');
            updateWamLastDropdown();
            
            // Populate CTP buttons
            const ctpDiv = document.getElementById('ctpBtns');
            ctpDiv.innerHTML = PLAYERS.map(p => `
                <button class="btn btn-option ${holeData.ctpWinner === p ? 'selected' : ''}" 
                        data-value="${p}" onclick="selectCTP(this)">
                    ${p}
                </button>
            `).join('');
            
            // Restore Bel Air selection
            document.querySelectorAll('#belAirBtns .btn-option').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.value === holeData.belAir);
            });
            
            // Restore Par 3 state
            const par3Btn = document.getElementById('par3Btn');
            const par3Section = document.getElementById('par3Section');
            if (holeData.isPar3) {
                par3Btn.classList.add('selected');
                par3Section.classList.remove('hidden');
            } else {
                par3Btn.classList.remove('selected');
                par3Section.classList.add('hidden');
            }
            
            // CTP none selection
            document.querySelectorAll('#par3Section .btn-option[data-value="none"]').forEach(btn => {
                btn.classList.toggle('selected', holeData.isPar3 && holeData.ctpWinner === null);
            });
            
            // Navigation buttons
            document.getElementById('prevHoleBtn').style.display = hole > 1 ? 'block' : 'none';
            document.getElementById('nextHoleBtn').textContent = 
                hole === 18 ? 'Finish Round ‚Üí' : 'Next Hole ‚Üí';
        }
        
        // ==================== HOLE TRACKING ACTIONS ====================
        function selectBelAir(btn) {
            document.querySelectorAll('#belAirBtns .btn-option').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            gameState.holes[gameState.currentHole - 1].belAir = btn.dataset.value;
            saveState();
        }
        
        function toggleSnake(element) {
            const player = element.dataset.player;
            const holeData = gameState.holes[gameState.currentHole - 1];
            const index = holeData.threePutts.indexOf(player);
            
            if (index > -1) {
                holeData.threePutts.splice(index, 1);
                element.classList.remove('checked');
            } else {
                holeData.threePutts.push(player);
                element.classList.add('checked');
            }
            
            saveState();
            updateSidebar();
        }
        
        function toggleWam(element) {
            const player = element.dataset.player;
            const holeData = gameState.holes[gameState.currentHole - 1];
            const index = holeData.wams.indexOf(player);
            
            if (index > -1) {
                holeData.wams.splice(index, 1);
                element.classList.remove('checked');
            } else {
                holeData.wams.push(player);
                element.classList.add('checked');
            }
            
            updateWamLastDropdown();
            saveState();
            updateSidebar();
        }
        
        function updateWamLastDropdown() {
            const holeData = gameState.holes[gameState.currentHole - 1];
            const select = document.getElementById('wamLastPlayer');
            const container = document.getElementById('wamLastSelect');
            
            if (holeData.wams.length > 1) {
                container.style.display = 'block';
                select.innerHTML = '<option value="">-- Select --</option>' +
                    holeData.wams.map(p => `<option value="${p}" ${holeData.wamLast === p ? 'selected' : ''}>${p}</option>`).join('');
            } else if (holeData.wams.length === 1) {
                container.style.display = 'none';
                holeData.wamLast = holeData.wams[0];
            } else {
                container.style.display = 'none';
                holeData.wamLast = null;
            }
        }
        
        function updateWamLast() {
            const holeData = gameState.holes[gameState.currentHole - 1];
            holeData.wamLast = document.getElementById('wamLastPlayer').value || null;
            saveState();
            updateSidebar();
        }
        
        function togglePar3() {
            const btn = document.getElementById('par3Btn');
            const section = document.getElementById('par3Section');
            const holeData = gameState.holes[gameState.currentHole - 1];
            
            holeData.isPar3 = !holeData.isPar3;
            btn.classList.toggle('selected', holeData.isPar3);
            section.classList.toggle('hidden', !holeData.isPar3);
            
            if (!holeData.isPar3) {
                holeData.ctpWinner = null;
            }
            
            saveState();
        }
        
        function selectCTP(btn) {
            const holeData = gameState.holes[gameState.currentHole - 1];
            const value = btn.dataset.value;
            
            document.querySelectorAll('#par3Section .btn-option').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            
            holeData.ctpWinner = value === 'none' ? null : value;
            saveState();
        }
        
        // ==================== NAVIGATION ====================
        function nextHole() {
            // Process current hole
            processHole(gameState.currentHole);
            
            if (gameState.currentHole === 18) {
                showSummary();
            } else {
                gameState.currentHole++;
                
                // Add $10 to snake pot at hole 10
                if (gameState.currentHole === 10) {
                    gameState.snake.backPot = 10;
                    gameState.snake.currentHolders = [];
                    gameState.wam.currentHolder = null;
                }
                
                saveState();
                populateHoleUI();
                updateSidebar();
                window.scrollTo(0, 0);
            }
        }
        
        function prevHole() {
            if (gameState.currentHole > 1) {
                gameState.currentHole--;
                saveState();
                populateHoleUI();
                updateSidebar();
                window.scrollTo(0, 0);
            }
        }
        
        // ==================== GAME LOGIC ====================
        function processHole(holeNum) {
            const holeData = gameState.holes[holeNum - 1];
            const isBack9 = holeNum > 9;
            
            // Process Bel Air
            if (holeData.belAir === 'team1') {
                if (gameState.belAir.closedOut) {
                    gameState.belAir.newBetTeam1Holes++;
                } else {
                    gameState.belAir.team1Holes++;
                }
            } else if (holeData.belAir === 'team2') {
                if (gameState.belAir.closedOut) {
                    gameState.belAir.newBetTeam2Holes++;
                } else {
                    gameState.belAir.team2Holes++;
                }
            }
            
            // Check for closeout
            if (!gameState.belAir.closedOut) {
                const holesRemaining = 18 - holeNum;
                const diff = Math.abs(gameState.belAir.team1Holes - gameState.belAir.team2Holes);
                if (diff > holesRemaining) {
                    gameState.belAir.closedOut = true;
                    gameState.belAir.closedOutHole = holeNum;
                    gameState.belAir.currentBet = 30;
                }
            }
            
            // Process Snake
            holeData.threePutts.forEach(player => {
                if (!gameState.snake.currentHolders.includes(player)) {
                    gameState.snake.currentHolders.push(player);
                }
                // Add $10 to pot
                if (isBack9) {
                    gameState.snake.backPot += 10;
                } else {
                    gameState.snake.frontPot += 10;
                }
            });
            
            // Process WAM
            if (holeData.wamLast) {
                gameState.wam.currentHolder = holeData.wamLast;
                // Add $15 to pot for each WAM
                const wamAmount = holeData.wams.length * 15;
                if (isBack9) {
                    gameState.wam.backPot += wamAmount;
                } else {
                    gameState.wam.frontPot += wamAmount;
                }
            }
            
            // Store snake/wam holders at end of 9/18
            if (holeNum === 9) {
                gameState.snake.frontHolders = [...gameState.snake.currentHolders];
                gameState.wam.frontHolder = gameState.wam.currentHolder;
            } else if (holeNum === 18) {
                gameState.snake.backHolders = [...gameState.snake.currentHolders];
                gameState.wam.backHolder = gameState.wam.currentHolder;
            }
            
            // Process CTP
            if (holeData.isPar3) {
                if (holeData.ctpWinner) {
                    const amount = 15 + gameState.ctp.rollover;
                    gameState.ctp.results.push({
                        hole: holeNum,
                        winner: holeData.ctpWinner,
                        amount: amount
                    });
                    gameState.ctp.rollover = 0;
                } else {
                    gameState.ctp.rollover += 15;
                }
            }
            
            saveState();
        }
        
        // ==================== SIDEBAR UPDATE ====================
        function updateSidebar() {
            // Recalculate state up to current hole
            recalculateState();
            
            // Bel Air
            const ba = gameState.belAir;
            document.getElementById('belAirScore').textContent = 
                `${ba.team1Holes} - ${ba.team2Holes}`;
            
            if (ba.closedOut) {
                const winner = ba.team1Holes > ba.team2Holes ? 
                    gameState.teams.team1.join(' & ') : 
                    gameState.teams.team2.join(' & ');
                document.getElementById('belAirMatchStatus').textContent = 
                    `Closed out on hole ${ba.closedOutHole}`;
                document.getElementById('belAirBetStatus').textContent = 
                    `$30/man new bet (${ba.newBetTeam1Holes} - ${ba.newBetTeam2Holes})`;
            } else {
                const holesRemaining = 18 - gameState.currentHole + 1;
                document.getElementById('belAirMatchStatus').textContent = 
                    `${holesRemaining} holes remaining`;
                document.getElementById('belAirBetStatus').textContent = '$60/man bet active';
            }
            
            // Snake
            const isBack9 = gameState.currentHole > 9;
            const snakePot = isBack9 ? gameState.snake.backPot : gameState.snake.frontPot;
            document.getElementById('snakePot').textContent = `Pot: $${snakePot}`;
            
            const snakeHolders = gameState.snake.currentHolders;
            document.getElementById('snakeHolders').textContent = 
                snakeHolders.length > 0 ? snakeHolders.join(', ') + ' has the snake' : 'No one has the snake';
            
            // WAM
            const wamPot = isBack9 ? gameState.wam.backPot : gameState.wam.frontPot;
            document.getElementById('wamPot').textContent = `Pot: $${wamPot}`;
            document.getElementById('wamHolder').textContent = 
                gameState.wam.currentHolder ? `${gameState.wam.currentHolder} has the WAM` : 'No one has the WAM';
            
            // CTP Rollover
            document.getElementById('ctpRollover').textContent = `$${gameState.ctp.rollover}`;
            
            // Current Balances (simplified preview)
            updateBalancesPreview();
        }
        
        function recalculateState() {
            // Reset calculations
            gameState.belAir = {
                team1Holes: 0,
                team2Holes: 0,
                currentBet: 60,
                closedOut: false,
                closedOutHole: null,
                newBetTeam1Holes: 0,
                newBetTeam2Holes: 0
            };
            gameState.snake = {
                frontPot: 10,
                backPot: 0,
                frontHolders: [],
                backHolders: [],
                currentHolders: []
            };
            gameState.wam = {
                frontPot: 0,
                backPot: 0,
                frontHolder: null,
                backHolder: null,
                currentHolder: null
            };
            gameState.ctp.rollover = 0;
            gameState.ctp.results = [];
            
            // Replay all holes up to current
            for (let i = 1; i <= gameState.currentHole; i++) {
                const holeData = gameState.holes[i - 1];
                const isBack9 = i > 9;
                
                // Reset at hole 10
                if (i === 10) {
                    gameState.snake.backPot = 10;
                    gameState.snake.currentHolders = [];
                    gameState.wam.currentHolder = null;
                }
                
                // Bel Air
                if (holeData.belAir === 'team1') {
                    if (gameState.belAir.closedOut) {
                        gameState.belAir.newBetTeam1Holes++;
                    } else {
                        gameState.belAir.team1Holes++;
                    }
                } else if (holeData.belAir === 'team2') {
                    if (gameState.belAir.closedOut) {
                        gameState.belAir.newBetTeam2Holes++;
                    } else {
                        gameState.belAir.team2Holes++;
                    }
                }
                
                // Check closeout
                if (!gameState.belAir.closedOut && i < 18) {
                    const holesRemaining = 18 - i;
                    const diff = Math.abs(gameState.belAir.team1Holes - gameState.belAir.team2Holes);
                    if (diff > holesRemaining) {
                        gameState.belAir.closedOut = true;
                        gameState.belAir.closedOutHole = i;
                    }
                }
                
                // Snake
                holeData.threePutts.forEach(player => {
                    if (!gameState.snake.currentHolders.includes(player)) {
                        gameState.snake.currentHolders.push(player);
                    }
                    if (isBack9) {
                        gameState.snake.backPot += 10;
                    } else {
                        gameState.snake.frontPot += 10;
                    }
                });
                
                if (i === 9) {
                    gameState.snake.frontHolders = [...gameState.snake.currentHolders];
                }
                
                // WAM
                if (holeData.wamLast) {
                    gameState.wam.currentHolder = holeData.wamLast;
                }
                holeData.wams.forEach(() => {
                    if (isBack9) {
                        gameState.wam.backPot += 15;
                    } else {
                        gameState.wam.frontPot += 15;
                    }
                });
                
                if (i === 9) {
                    gameState.wam.frontHolder = gameState.wam.currentHolder;
                }
                
                // CTP
                if (holeData.isPar3) {
                    if (holeData.ctpWinner) {
                        const amount = 15 + gameState.ctp.rollover;
                        gameState.ctp.results.push({
                            hole: i,
                            winner: holeData.ctpWinner,
                            amount: amount
                        });
                        gameState.ctp.rollover = 0;
                    } else {
                        gameState.ctp.rollover += 15;
                    }
                }
            }
        }
        
        function updateBalancesPreview() {
            const balDiv = document.getElementById('currentBalances');
            // Just show placeholder for now - full calculation at end
            balDiv.innerHTML = PLAYERS.map(p => `
                <div class="player-balance">
                    <span class="name">${p}</span>
                    <span class="amount">--</span>
                </div>
            `).join('');
        }
        
        // ==================== FINAL PAYOUTS ====================
        function calculateFinalPayouts() {
            // Reset balances
            PLAYERS.forEach(p => gameState.balances[p] = 0);
            
            // Recalculate full state
            recalculateState();
            gameState.snake.backHolders = [...gameState.snake.currentHolders];
            gameState.wam.backHolder = gameState.wam.currentHolder;
            
            // ===== BEL AIR =====
            const ba = gameState.belAir;
            let belAirWinners, belAirLosers, belAirAmount;
            
            if (ba.closedOut) {
                // Original bet winner
                const origWinners = ba.team1Holes > ba.team2Holes ? gameState.teams.team1 : gameState.teams.team2;
                const origLosers = ba.team1Holes > ba.team2Holes ? gameState.teams.team2 : gameState.teams.team1;
                
                // Check new bet
                if (ba.newBetTeam1Holes !== ba.newBetTeam2Holes) {
                    const newWinners = ba.newBetTeam1Holes > ba.newBetTeam2Holes ? gameState.teams.team1 : gameState.teams.team2;
                    
                    if (newWinners[0] === origWinners[0]) {
                        // Same team won both - $90
                        belAirWinners = origWinners;
                        belAirLosers = origLosers;
                        belAirAmount = 90;
                    } else {
                        // Different teams won - original winners get $30
                        belAirWinners = origWinners;
                        belAirLosers = origLosers;
                        belAirAmount = 30;
                    }
                } else {
                    // New bet pushed - original winners get $60
                    belAirWinners = origWinners;
                    belAirLosers = origLosers;
                    belAirAmount = 60;
                }
            } else {
                // No closeout - compare holes
                if (ba.team1Holes > ba.team2Holes) {
                    belAirWinners = gameState.teams.team1;
                    belAirLosers = gameState.teams.team2;
                    belAirAmount = 60;
                } else if (ba.team2Holes > ba.team1Holes) {
                    belAirWinners = gameState.teams.team2;
                    belAirLosers = gameState.teams.team1;
                    belAirAmount = 60;
                } else {
                    belAirWinners = null;
                    belAirLosers = null;
                    belAirAmount = 0;
                }
            }
            
            if (belAirWinners) {
                belAirWinners.forEach(p => gameState.balances[p] += belAirAmount);
                belAirLosers.forEach(p => gameState.balances[p] -= belAirAmount);
            }
            
            gameState.belAirResult = { winners: belAirWinners, losers: belAirLosers, amount: belAirAmount };
            
            // ===== SNAKE =====
            // Front 9
            calculateSnakePayout(gameState.snake.frontHolders, gameState.snake.frontPot, 'front');
            // Back 9
            calculateSnakePayout(gameState.snake.backHolders, gameState.snake.backPot, 'back');
            
            // ===== WAM =====
            // Front 9
            calculateWamPayout(gameState.wam.frontHolder, gameState.wam.frontPot, gameState.snake.frontHolders, 'front');
            // Back 9
            calculateWamPayout(gameState.wam.backHolder, gameState.wam.backPot, gameState.snake.backHolders, 'back');
            
            // ===== CTP =====
            gameState.ctp.results.forEach(ctp => {
                gameState.balances[ctp.winner] += ctp.amount;
                const losers = PLAYERS.filter(p => p !== ctp.winner);
                losers.forEach(p => gameState.balances[p] -= ctp.amount / 3);
            });
            
            saveState();
        }
        
        function calculateSnakePayout(holders, pot, nine) {
            if (holders.length === 0) {
                // No one had the snake - pot stays (or splits evenly?)
                // Based on rules, someone must have snake to lose
                return;
            }
            
            const nonHolders = PLAYERS.filter(p => !holders.includes(p));
            
            if (nonHolders.length === 0) {
                // Everyone had the snake - no payout
                return;
            }
            
            // Snake holders lose, non-holders split the pot
            const winPerPerson = pot / nonHolders.length;
            const lossPerPerson = pot / holders.length;
            
            nonHolders.forEach(p => gameState.balances[p] += winPerPerson);
            holders.forEach(p => gameState.balances[p] -= lossPerPerson);
            
            gameState[`snake${nine.charAt(0).toUpperCase() + nine.slice(1)}Result`] = {
                holders, nonHolders, pot, winPerPerson, lossPerPerson
            };
        }
        
        function calculateWamPayout(holder, pot, snakeHolders, nine) {
            if (!holder || pot === 0) return;
            
            // WAM winner gets pot
            // Non-snake-winners pay 1/3 of pot each
            // This means snake losers pay the WAM winner
            
            const snakeLosers = snakeHolders.length > 0 ? snakeHolders : [];
            const payers = snakeLosers.length > 0 ? snakeLosers : PLAYERS.filter(p => p !== holder);
            
            if (payers.length === 0) return;
            
            const payPerPerson = pot / payers.length;
            
            gameState.balances[holder] += pot;
            payers.forEach(p => {
                if (p !== holder) {
                    gameState.balances[p] -= payPerPerson;
                }
            });
            
            gameState[`wam${nine.charAt(0).toUpperCase() + nine.slice(1)}Result`] = {
                holder, pot, payers, payPerPerson
            };
        }
        
        // ==================== SUMMARY RENDER ====================
        function renderSummary() {
            // Bel Air Summary
            const ba = gameState.belAir;
            const baResult = gameState.belAirResult;
            let baSummary = `
                <div style="padding: 15px; background: #fff; border-radius: 8px; margin: 10px 0;">
                    <p><strong>Final Score:</strong> ${gameState.teams.team1.join(' & ')}: ${ba.team1Holes} holes | ${gameState.teams.team2.join(' & ')}: ${ba.team2Holes} holes</p>
            `;
            
            if (ba.closedOut) {
                baSummary += `<p><strong>Closeout:</strong> Occurred on hole ${ba.closedOutHole}</p>`;
                baSummary += `<p><strong>New Bet Score:</strong> ${ba.newBetTeam1Holes} - ${ba.newBetTeam2Holes}</p>`;
            }
            
            if (baResult.winners) {
                baSummary += `<p><strong>Winners:</strong> ${baResult.winners.join(' & ')} (+$${baResult.amount} each)</p>`;
            } else {
                baSummary += `<p><strong>Result:</strong> Push - no money exchanged</p>`;
            }
            
            baSummary += '</div>';
            document.getElementById('belAirSummary').innerHTML = baSummary;
            
            // Hole Summary Table
            const tbody = document.getElementById('holeSummaryBody');
            tbody.innerHTML = gameState.holes.map((h, i) => {
                const holeNum = i + 1;
                const rowClass = (holeNum === 9 || holeNum === 18) ? 'hole-9' : '';
                
                let belAirText = h.belAir === 'team1' ? gameState.teams.team1.join('/') :
                                 h.belAir === 'team2' ? gameState.teams.team2.join('/') :
                                 h.belAir === 'push' ? 'Push' : '-';
                
                return `
                    <tr class="${rowClass}">
                        <td>${holeNum}</td>
                        <td>${belAirText}</td>
                        <td>${h.threePutts.join(', ') || '-'}</td>
                        <td>${h.wamLast || '-'}</td>
                        <td>${h.isPar3 ? (h.ctpWinner || 'Rollover') : '-'}</td>
                    </tr>
                `;
            }).join('');
            
            // Game Payouts
            let payouts = '<div style="display: grid; gap: 15px;">';
            
            // Snake payouts
            ['Front', 'Back'].forEach(nine => {
                const result = gameState[`snake${nine}Result`];
                if (result && result.holders.length > 0) {
                    payouts += `
                        <div style="padding: 15px; background: #fff; border-radius: 8px;">
                            <strong>Snake (${nine} 9) - Pot: $${result.pot}</strong><br>
                            Losers: ${result.holders.join(', ')} (-$${result.lossPerPerson.toFixed(2)} each)<br>
                            Winners: ${result.nonHolders.join(', ')} (+$${result.winPerPerson.toFixed(2)} each)
                        </div>
                    `;
                }
            });
            
            // WAM payouts
            ['Front', 'Back'].forEach(nine => {
                const result = gameState[`wam${nine}Result`];
                if (result && result.holder) {
                    payouts += `
                        <div style="padding: 15px; background: #fff; border-radius: 8px;">
                            <strong>WAM (${nine} 9) - Pot: $${result.pot}</strong><br>
                            Winner: ${result.holder} (+$${result.pot})<br>
                            Payers: ${result.payers.join(', ')} (-$${result.payPerPerson.toFixed(2)} each)
                        </div>
                    `;
                }
            });
            
            // CTP payouts
            if (gameState.ctp.results.length > 0) {
                payouts += `
                    <div style="padding: 15px; background: #fff; border-radius: 8px;">
                        <strong>CTP Results</strong><br>
                        ${gameState.ctp.results.map(c => 
                            `Hole ${c.hole}: ${c.winner} (+$${c.amount})`
                        ).join('<br>')}
                    </div>
                `;
            }
            
            payouts += '</div>';
            document.getElementById('gamePayouts').innerHTML = payouts;
            
            // Final Totals
            const totalsDiv = document.getElementById('finalTotals');
            totalsDiv.innerHTML = PLAYERS.map(p => {
                const amount = gameState.balances[p];
                const amountClass = amount >= 0 ? 'positive' : 'negative';
                const sign = amount >= 0 ? '+' : '';
                return `
                    <div class="total-card">
                        <div class="player-name">${p}</div>
                        <div class="total-amount ${amountClass}">${sign}$${amount.toFixed(2)}</div>
                    </div>
                `;
            }).join('');
        }
        
        // ==================== INITIALIZATION ====================
        function init() {
            if (loadState()) {
                // Resume existing round
                if (gameState.teams.team1.length > 0) {
                    if (gameState.currentHole > 18 || 
                        (gameState.holes[17] && gameState.holes[17].belAir !== null)) {
                        showSummary();
                    } else {
                        showHoleTracking();
                    }
                }
            }
            
            // Check for midnight reset
            setInterval(() => {
                const saved = localStorage.getItem('degenerateGolfRound');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.savedDate !== new Date().toDateString()) {
                        resetRound();
                    }
                }
            }, 60000); // Check every minute
        }
        
        init();
    </script>
</body>
</html>